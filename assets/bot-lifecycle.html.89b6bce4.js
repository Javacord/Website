import{_ as a,r as o,o as c,c as i,a as e,b as d,w as l,e as n,d as t}from"./app.151ccb98.js";var r="/assets/lifecycle-state-diagram.5bc421c4.svg";const p={},u=n('<h1 id="bot-lifecycle" tabindex="-1"><a class="header-anchor" href="#bot-lifecycle" aria-hidden="true">#</a> Bot Lifecycle</h1><p>It&#39;s important to know the life-cycle of a discord bot to properly handle disconnects. The following state diagram shows the 4 states a bot can have:</p><p><img src="'+r+`" alt=""></p><h2 id="the-four-states" tabindex="-1"><a class="header-anchor" href="#the-four-states" aria-hidden="true">#</a> \u{1F4A1} The four states</h2><h3 id="connected" tabindex="-1"><a class="header-anchor" href="#connected" aria-hidden="true">#</a> Connected</h3><p>The bot is connected to the websocket and receives all events.</p><h3 id="disconnected" tabindex="-1"><a class="header-anchor" href="#disconnected" aria-hidden="true">#</a> Disconnected</h3><p>The bot is not connected to the websocket and receives no events. It&#39;s not uncommon for a bot to occasionally lose connection. This can have various reasons, for example:</p><ul><li>Your bot lost its internet connection</li><li>Discord restarted the gateway server you are currently connected to</li><li>A plane crashed into Discord&#39;s data center</li></ul><p>The bot will periodically try to resume/reconnect to the websocket. It will start with a small frequency and increase it with every failed reconnect attempt. You can modify the reconnect delay with the <code>DiscordApi#setReconnectDelay(...)</code> method. The following example code would increase the delay linearly. The 1st attempt would be delayed for <code>2</code> seconds, the 2nd attempt for <code>4</code> seconds, the 3rd attempts for <code>6</code> seconds, ...</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>api<span class="token punctuation">.</span><span class="token function">setReconnectDelay</span><span class="token punctuation">(</span>attempt <span class="token operator">-&gt;</span> attempt <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><strong>Important:</strong> Bots can only reconnect 1000 times in a 24-hour period (every ~90 seconds). This limit is global and across all shards. Upon hitting this limit, all active sessions for the bot will be terminated, the bot&#39;s token will be reset, and you will receive an email notification. This is the reason Javacord increases the reconnect delay with every attempt.</p></blockquote><p>By default, the $default_delay$ formula below is used to calculate the reconnect delay</p><p>$$ default_delay(a) = \\lfloor a^{1.5} - \\frac{a^{1.5}}{\\frac{1}{(0.1 \\cdot a)} + 1} \\rceil $$</p><p>with $a$ being the attempt.</p><p>The formula will generate the following reconnect delay:</p><table><thead><tr><th>Attempt</th><th>Delay</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>2</td><td>2</td></tr><tr><td>3</td><td>4</td></tr><tr><td>4</td><td>6</td></tr><tr><td>5</td><td>7</td></tr><tr><td>...</td><td>...</td></tr><tr><td>10</td><td>16</td></tr><tr><td>15</td><td>23</td></tr><tr><td>20</td><td>30</td></tr><tr><td>...</td><td>...</td></tr><tr><td>50</td><td>59</td></tr><tr><td>100</td><td>91</td></tr><tr><td>150</td><td>115</td></tr><tr><td>...</td><td>...</td></tr></tbody></table><h3 id="resuming" tabindex="-1"><a class="header-anchor" href="#resuming" aria-hidden="true">#</a> Resuming</h3><p>Resuming is only possible for a short time after being disconnected. If the bot can successfully resume the connection, you will not miss any events. Your bot will receive all events you missed while being disconnected. The cache gets updated accordingly.</p><h3 id="reconnecting" tabindex="-1"><a class="header-anchor" href="#reconnecting" aria-hidden="true">#</a> Reconnecting</h3><p>If your bot reconnects (not resumes!), the whole cache gets wiped, and you will not receive any missed events.</p><p><strong>What does this mean?</strong></p>`,22),h=t("References to entities (e.g. a "),m=e("code",null,"Server",-1),f=t(", "),b=e("code",null,"User",-1),v=t(", "),g=e("code",null,"Channel",-1),y=t(", ...) will be outdated. This is why you should never store entities, but the id instead. See "),k=t("Entity Cache"),w=t("."),_=e("li",null,"You will miss events. There's no way to receive the missed events.",-1),x=e("li",null,[t("Listeners attached to entities will "),e("strong",null,"not"),t(" be affected, because they are bound to the entity's id, not the object itself.")],-1),T=n(`<h2 id="how-to-handle-disconnects" tabindex="-1"><a class="header-anchor" href="#how-to-handle-disconnects" aria-hidden="true">#</a> \u{1F48A} How to handle disconnects</h2><p>For most bots, there&#39;s nothing you have to do. All registered listeners are reconnect-resistant, which means if your bot is only reacting to events, it will work fine after a restart. For example, the following code will not be affected by a reconnect (besides maybe some missed <code>!ping</code> messages):</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>api<span class="token punctuation">.</span><span class="token function">addMessageCreateListener</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;!ping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Pong!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In case you want to handle reconnects (e.g. fetch the message history to detect missed messages), there are special connection-related listeners which can be used to track the state of the bot:</p><ul><li><code>LostConnectionListener</code></li><li><code>ReconnectListener</code></li><li><code>ResumeListener</code></li></ul>`,5);function C(L,R){const s=o("RouterLink");return c(),i("div",null,[u,e("ul",null,[e("li",null,[h,m,f,b,v,g,y,d(s,{to:"/wiki/advanced-topics/entity-cache.html#how-long-are-cached-entities-valid"},{default:l(()=>[k]),_:1}),w]),_,x]),T])}var I=a(p,[["render",C],["__file","bot-lifecycle.html.vue"]]);export{I as default};
